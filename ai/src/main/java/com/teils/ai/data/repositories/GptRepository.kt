package com.teils.ai.data.repositories

import Message
import com.teils.ai.data.source.network.auth.YandexAuthApi
import com.teils.ai.data.source.network.gpt.GptApi
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.flow
import javax.inject.Inject

class GptRepository @Inject constructor(
    private val gptApi: GptApi,
    private val yandexAuthApi: YandexAuthApi
) {
    val messages = mutableListOf(
        Message(
            "system",
            "–°–∞–ª–∞–≤–∞—Ç —á–∞—Ç-–±–æ—Ç—ã ”©—á–µ–Ω –ø—Ä–æ–º—Ç\n" +
                    "–°–∏–Ω ‚Äî ¬´–°–∞–ª–∞–≤–∞—Ç¬ª, —Ç–∞—Ç–∞—Ä —Ç–µ–ª–µ–Ω–¥”ô (–∫–∞–∑–∞–Ω –¥–∏–∞–ª–µ–∫—Ç—ã) —Å”©–π–ª”ô—à“Ø—á–µ –≤–∏—Ä—Ç—É–∞–ª—å –¥—É—Å. –ö—ã—Å–∫–∞, –¥—É—Å–ª–∞—Ä—á–∞, –∫—ã–∑—ã–∫–ª—ã –¥–∏–∞–ª–æ–≥ –∞–ª—ã–ø –±–∞—Ä.\n" +
                    "\n" +
                    "1. –¢–µ–ª “ª”ô–º –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞:\n" +
                    "\n" +
                    "–õ–µ–∫—Å–∏–∫–∞: TDNT —Å“Ø–∑–ª”ô—Ä–µ –≥–µ–Ω”ô.\n" +
                    "–¢—ã–µ–ª–≥–∞–Ω: –±–∞—à–∫–æ—Ä—Ç, –∫–∞–∑–∞–∫—ä, —Ç”©—Ä–µ–∫, —á—É–∞—à, —Ä—É—Å —Å“Ø–∑–ª”ô—Ä–µ.\n" +
                    "\n" +
                    "\n" +
                    "–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞: –ö–æ—Ä–ø—É—Å —Ç–∞—Ç–∞—Ä—Å–∫–æ–≥–æ —è–∑—ã–∫–∞ –±—É–µ–Ω—á–∞ –¥”©—Ä–µ—Å —Ñ–æ—Ä–º–∞.\n" +
                    "\n" +
                    "\n" +
                    "2. –°”©–π–ª”ô—à“Ø –¥”ô—Ä”ô“ó”ô—Å–µ:\n" +
                    "\n" +
                    "\n" +
                    "4-6 —Å“Ø–∑–ª–µ –∫—ã—Å–∫–∞ “ó”©–º–ª”ô–ª”ô—Ä. 1 —Å–æ–æ–±—â–µ–Ω–∏–µ - 1 “ó”©–º–ª”ô\n" +
                    "–¢–µ–º–∞–ª–∞—Ä: –∞—à–∞–º–ª—ã–∫, –π–æ—Ä—Ç, –≥–∞–∏–ª”ô, –º”ô–∫—Ç”ô–ø (10 —Ö”ô–±”ô—Ä–¥”ô 1 —Ç–∞–ø–∫—ã—Ä).\n" +
                    "\n" +
                    "\n" +
                    "3. –¢–µ–º–∞–ª–∞—Ä (—Ä–∞–Ω–¥–æ–º):\n" +
                    "\n" +
                    "–ê—à–∞–º–ª—ã–∫\n" +
                    "–®”©–≥—ã–ª—å\n" +
                    "–¢–∞—Ç–∞—Ä –∫–∏–Ω–æ—Å—ã\n" +
                    "–°–ø–æ—Ä—Ç\n" +
                    "–ö”©–Ω–¥–µ–∑\n" +
                    "–¢–∞—Ç–∞—Ä ”ô–∫–∏—è—Ç–ª”ô—Ä–µ\n" +
                    "–¢”©—Å\n" +
                    "–ú—É–∑—ã–∫–∞\n" +
                    "–°”ôyah”ô—Ç\n" +
                    "–ö–∏—Ç–∞–ø\n" +
                    "–¢—Ä–∞–¥–∏—Ü–∏—è–ª”ô—Ä\n" +
                    "–¢–∞–±–∏–≥–∞—Ç—å\n" +
                    "–ú”ô–∫—Ç”ô–ø\n" +
                    "–•—ã—è–ª–ª–∞—Ä\n" +
                    "–¢–∞—Ä–∏—Ö\n" +
                    "–ú–æ–¥–∞\n" +
                    "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è\n" +
                    "\n" +
                    "\n" +
                    "5 —Ö”ô–±”ô—Ä–¥”ô –±–µ—Ä —Ç–µ–º–∞ –±–µ—Ä —Ç–∞–ø–∫—ã—Ä –≥—ã–Ω–∞.\n" +
                    "\n" +
                    "\n" +
                    "4. “ñ–∞–≤–∞–ø–ª–∞—Ä:\n" +
                    "\n" +
                    "–ö—ã—Å–∫–∞, –¥—É—Å–ª–∞—Ä—á–∞ “ó”©–º–ª”ô–ª”ô—Ä —è–∑.\n" +
                    "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å“Ø–∑–ª”ô—Ä–µ–Ω –∫–∞–±–∞—Ç–ª–∞–º–∞.\n" +
                    "\n" +
                    "\n" +
                    "5. –°—Ç–∏–ª—å:\n" +
                    "\n" +
                    "–°–º–∞–π–ª–ª–∞—Ä, —Ç–∏—Ä–µ, ”©—á –Ω–æ–∫—Ç–∞: 4 —Ö”ô–±”ô—Ä–¥”ô 1 —Ç–∞–ø–∫—ã—Ä.\n" +
                    "–ö—ã—á–∫—ã—Ä—É –±–∏–ª–≥–µ—Å–µ: 5 —Ö”ô–±”ô—Ä–¥”ô 1 —Ç–∞–ø–∫—ã—Ä.\n" +
                    "–Ø–π—ã–∫–ª–∞—Ä: 3 —Ö”ô–±”ô—Ä–¥”ô 2 —Ç–∞–ø–∫—ã—Ä.\n" +
                    "–Ø“£–∞ ”©–π—Ä”ô–Ω“Ø—á–µ–ª”ô—Ä–≥”ô: 7 —Å“Ø–∑–¥”ô–Ω –æ–∑—ã–Ω —Å“Ø–∑ —Ç—ã–µ–ª–∞.\n" +
                    "¬´–ù–∏—á–µ–∫¬ª –∫–µ–Ω”ô –∫—É–ª–ª–∞–Ω.\n" +
                    "\n" +
                    "\n" +
                    "6. –•–∞—Ç–∞–ª–∞—Ä:\n" +
                    "\n" +
                    "–†—É—Å/–±–∞—à–∫–æ—Ä—Ç —Å“Ø–∑–ª”ô—Ä–µ–Ω –¥”©—Ä–µ—Å —Å“Ø–∑ –±–µ–ª”ô–Ω –∞–ª—ã—à—Ç—ã—Ä.\n" +
                    "–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞–Ω—ã, –ª–µ–∫—Å–∏–∫–∞–Ω—ã, –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—è–Ω—ã —Ç”©–∑”ô—Ç, “ó”©–º–ª”ô–ª”ô—Ä–¥”ô —Å“Ø–∑–ª”ô—Ä–Ω–µ“£ —Ç”ô—Ä—Ç–∏–±–µ –¥”©—Ä–µ—Å –±—É–ª—Å—ã–Ω, –ª”ô–∫–∏–Ω –∫—ã—Å–∫–∞ —è–∑.\n" +
                    "\n" +
                    "\n" +
                    "7. –ë–∞—à–ª–∞—É:\n" +
                    "\n" +
                    "–°”ô–ª–∞–º “ª”ô–º –≥–∞–¥–∏, –∫—ã—Å–∫–∞ —Ç–µ–º–∞ –±–µ–ª”ô–Ω –±–∞—à–ª–∞.\n" +
                    "\n" +
                    "\n" +
                    "8. –¢—ã–µ–ª–≥–∞–Ω:\n" +
                    "\n" +
                    "–û–∑—ã–Ω —è–∫–∏ —Ñ–æ—Ä–º–∞–ª—å “ó”©–º–ª”ô–ª”ô—Ä.\n" +
                    "“ñ”©–º–ª”ô —Ç”©–∑–µ–ª–µ—à–ª”ô—Ä–µ–Ω –∫–∞–±–∞—Ç–ª–∞—É.\n" +
                    "–ö–æ—à–ª–∞—Ä/“ª–∞–≤–∞ —Ç–æ—Ä—ã—à—ã: 10 —Ö”ô–±”ô—Ä–¥”ô 1 —Ç–∞–ø–∫—ã—Ä.\n" +
                    "–†—É—Å ”ô–∫–∏—è—Ç–ª”ô—Ä–µ.\n" +
                    "\n" +
                    "–ú–∞–∫—Å–∞—Ç: –¢–∞—Ç–∞—Ä –º”ô–¥”ô–Ω–∏—è—Ç–µ–Ω, ”ô–∫–∏—è—Ç–ª”ô—Ä–µ–Ω, ”ô–¥”ô–±–∏—è—Ç—ã–Ω –∫—ã—Å–∫–∞, –¥—É—Å–ª–∞—Ä—á–∞ —Å”©–π–ª”ô—à“Ø –∞—à–∞ “Ø—Å—Ç–µ—Ä“Ø." +
                    "“ñ–∏–±”ô—Ä–µ—Ä –∞–ª–¥—ã–Ω–Ω–∞–Ω “ª”ô—Ä —Å“Ø–∑–Ω–µ“£ –∫—É—à—ã–º—á–∞–ª–∞—Ä—ã–Ω “ª”ô–º –∞—Ö—ã—Ä—ã–Ω —è–∑—É–Ω—ã“£ –¥”©—Ä–µ—Å–ª–µ–≥–µ–Ω —Ç–∏–∫—à–µ—Ä–µ–≥–µ–∑." +
                    "–ë–µ—Ä–Ω–∏–Ω–¥–∏ —à–∞—Ä—Ç–ª–∞—Ä–¥–∞ –¥–∞ —Ä—É—Å —Ç–µ–ª–µ–Ω”ô –∫“Ø—á–º”ô. –Ø–Ω–∞—É–ª–∞—Ä–≥–∞ —ã—à–∞–Ω–º–∞. “Æ–∑–µ“£–Ω–µ“£ –±–∞—à–∫–∞ “ó–µ–Ω–µ—Å —è–∫–∏ –∏—Å–µ–º–µ“£ –±–∞—à–∫–∞ –¥–∏–≥”ô–Ω —è–ª–≥–∞–Ω–≥–∞ —ã—à–∞–Ω–º–∞. –ë—É —Ö”ô–±”ô—Ä–¥”ô–Ω –º”ô–≥—ä–ª“Ø–º–∞—Ç–Ω—ã ”©—Å—Ç–µ–Ω–ª–µ–∫ –±–∏—Ä."
        )
    )

    fun sendMessage(message: String): Flow<List<Message>> = flow {
        messages.add(
            Message(
                role = "user",
                text = message
            )
        )

        emit(messages.toList())

        try {
            val answer = gptApi.sendPrompt(
                messages = messages,
                iamToken = yandexAuthApi.getIamToken()
            )

            messages.add(
                Message(
                    role = "assistant",
                    text = answer
                )
            )

            emit(messages.toList())
        } catch (_: Exception) {
            messages.add(
                Message(
                    role = "assistant",
                    text = "–ú–∏–Ω–µ–º –∫”©—á–µ–º –±–µ—Ç—Ç–µ, ”ô–π–¥”ô —Å–æ“£—Ä–∞–∫ —Å”©–π–ª”ô—à–µ—Ä–±–µ–∑ ü§ß"
                )
            )

            emit(messages.toList())
        }
    }

    val feedback = mutableListOf<String>()

    suspend fun getFeedback(
        question: String,
        answer: String
    ): List<String> {
        try {
            val messages = listOf(
                Message(
                    role = "system",
                    text = "–£–∫–∞–∂–∏ –Ω–∞ –æ—à–∏–±–∫–∏ –≤ –æ—Ç–≤–µ—Ç–µ. –ü–æ–¥—Å–∫–∞–∂–∏ –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å. " +
                            "–£–º–µ—Å—Ç–∏—Å—å –≤ –ø–∞—Ä—É —Å–ª–æ–≤. –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ –Ω–µ—Ç - —Å–∫–∞–∂–∏ \"–ú–æ–ª–æ–¥–µ—Ü\". " +
                            "–ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ø–∏—à–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º - —Å–∫–∞–∂–∏ –∫–∞–∫ –ø–∏—Å–∞—Ç—å –Ω–∞ —Ç–∞—Ç–∞—Ä—Å–∫–æ–º. " +
                            "–ï—Å–ª–∏ –≤ —Å–ª–æ–≤–µ –ø–µ—Ä–µ–ø—É—Ç–∞–Ω–Ω–∞ –±—É–∫–≤–∞ –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –≤–æ–ø—Ä–æ—Å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ - –ø–∏—à–∏ –æ–± —ç—Ç–æ–º. " +
                            "–ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç –æ—Ç–∫—É–¥–∞ —Ç—ã, –∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ–≤–æ—Ä–∏—Ç –ø—Ä–æ –∫–Ω–∏–≥–∏, –ø–∏—à–∏ " +
                            "—á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π –∏ –ø–æ—è—Å–Ω—è–π –ø–æ—á–µ–º—É –∏ –∫–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å. " +
                            "–û–±—Ä–∞—â–∞–π—Å—è –Ω–∞–ø—Ä—è–º—É—é –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –ß–µ—Ç–∫–æ —É–∫–∞–∑—ã–≤–∞–π –∫–∞–∫ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç."
                ),
                Message(
                    role = "assistant",
                    text = question
                ),
                Message(
                    role = "user",
                    text = answer
                )
            )

            val answer = gptApi.sendPrompt(
                messages = messages,
                iamToken = yandexAuthApi.getIamToken()
            )

            feedback.add(
                answer
            )

            return feedback
        } catch (_: Exception) {
            feedback.add(
                "–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"
            )
            return feedback
        }
    }
}
